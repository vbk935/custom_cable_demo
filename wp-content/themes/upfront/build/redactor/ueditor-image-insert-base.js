!function(t){upfrontrjs.define(["scripts/redactor/ueditor-insert","scripts/redactor/ueditor-inserts","text!scripts/redactor/ueditor-templates.html","scripts/redactor/ueditor-insert-utils"],function(e,i,a,n){var r=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.ueditor:Upfront.mainData.l10n.global.ueditor,o=e.UeditorInsert.extend({$editor:!1,caption_active:!1,className:"ueditor-insert upfront-inserted_image-wrapper",tpl:_.template(t(a).find("#image-insert-tpl").html()),resizable:!1,defaultData:{insert_type:"image_insert",caption:"<p>Default caption</p>",show_caption:1,imageFull:{src:"",width:100,height:100},imageThumb:{src:"",width:100,height:100},selectedImage:{src:"",width:100,height:100},linkType:"do_nothing",linkUrl:"",isLocal:1,alignment:{vid:"center",label:"Center"},externalImage:{top:0,left:0,width:0,height:0},variant_id:"",style:{label_id:"",vid:"",caption:{order:1,height:50,width_cls:"",left_cls:"ml0",top_cls:"mt0",show:1},group:{float:"none",width_cls:"",left_cls:"ml0",height:0,marginRight:0,marginLeft:0},image:{width_cls:"",left_cls:"ml0",top_cls:"mt0",src:"",height:0}}},wp_defaults:{insert_type:"wp_default",attachment_id:"",caption:"<p>Default caption</p>",link_url:"",image:{src:"",url:"",width:0,height:0},style:{wrapper:{alignment:"alignnone",width:"310"},caption:{show:!0},image:{size_class:"size-medium"}}},events:{"click .ueditor-insert-remove":"click_remove","dragstart img":"on_image_dragstart"},is_post_image_insert:function(){return!this.is_image_insert()},is_image_insert:function(){return this.className.indexOf("basic-wrapper")!==-1},get_type:function(){return!(!this.$editor||!this.$editor.data("ueditor"))&&(_.contains(this.$editor.data("ueditor").options.inserts,"image")?i.NAMES.IMAGE:i.NAMES.POSTIMAGE)},get_caption_state:function(){return this.data.get("show_caption")?0:1},click_remove:function(t){t.preventDefault(),this.trigger("remove",this)},get_data_json:function(){return"function"==typeof this.prepare_data?this.prepare_data():this.data.toJSON()},make_caption_editable:function(){var e=this,i=this.data.get("style"),a=this.$(".wp-caption-text"),n=this.data.get("show_caption")||!1;return n===!1&&i.caption&&(n=i.caption.show),!!i&&void(i.caption&&n&&0!==this.$(".wp-caption-text").length&&(a.off("keyup").on("keyup",function(t){e.data.set("caption",this.innerHTML,{silent:!0}),e.data.trigger("update"),e.render_shortcode&&e.render_shortcode(e.get_data_json())}).ueditor({linebreaks:!1,autostart:!0,pastePlainText:!0,buttons:[],placeholder:e.defaultData.caption,inserts:[],focus:!1,paragraphize:!1}).attr("contenteditable",!1),this.caption_ueditor=a.data("ueditor"),this.caption_ueditor.redactor.events.on("ueditor:change",function(t){e.data.set("caption",e.caption_ueditor.$el.html(),{silent:!0}),e.data.trigger("update"),e.render_shortcode&&e.render_shortcode(e.get_data_json())}),this.caption_ueditor.redactor.events.on("ueditor:focus",function(t){if(t==e.caption_ueditor.redactor){var i=e.$el.closest(".redactor-editor"),n=i.data("ueditor"),r=!!n&&n.redactor;r&&(t.$element.is(a)?(i.attr("contenteditable",!1),a.attr("contenteditable",!0),e.caption_active=!0):(i.attr("contenteditable",!0),a.attr("contenteditable",!1),e.caption_active=!1),r.$editor.off("drop.redactor paste.redactor keydown.redactor keyup.redactor focus.redactor blur.redactor"),r.$textarea.on("keydown.redactor-textarea"))}}),this.caption_ueditor.redactor.events.on("ueditor:blur",function(t){if(t==e.caption_ueditor.redactor){var i=e.$el.closest(".redactor-editor"),n=i.data("ueditor"),r=!!n&&n.redactor;r&&(t.$element.is(a)?(i.attr("contenteditable",!0),a.attr("contenteditable",!1),e.caption_active=!1):(i.attr("contenteditable",!1),a.attr("contenteditable",!0),e.caption_active=!0),r.build.setEvents())}}),e.$el.on("hover, click",function(t){t.stopPropagation();var i=e.$editor.is(".redactor-editor")?e.$editor:e.$editor.find(".upfront-object-content");a.attr("contenteditable",!0),i.attr("contenteditable",!1),e.caption_active=!0}),this.$editor.on("mouseenter, click",function(i){var n=t(this).is(".redactor-editor")?t(this):t(this).find(".upfront-object-content");a.attr("contenteditable",!1),n.attr("contenteditable",!0),e.caption_active=!1})))},controlEvents:function(){this.stopListening(this.controls),this.listenTo(this.controls,"control:ok:link",function(t,e){var i=t.$("input[type=text]").val(),a=t.$("input[type=radio]:checked").val()||"do_nothing",n={};"external"!==a||i.match(/https?:\/\//)||i.match(/\/\/:/)||(i=i.match(/^www\./)||i.match(/\./)?"http://"+i:i),n={linkType:a,linkUrl:i},this.data.set(n),t.model.set(n),e.close()}),this.listenTo(this.controls,"control:click:toggle_caption",function(t){var e=1;this.data.get("show_caption")&&(e=0),this.data.set("show_caption",e)}),this.listenTo(this.controls,"control:click:change_image",this.change_image),"function"==typeof this.control_events&&this.control_events()},updateControlsPosition:function(){this.controls.$el.css({left:-1,top:(this.controls.$el.height()+1)*-1})},getSimpleOutput:function(){var e=this.el.cloneNode(!0),i=this.data.toJSON();return i.image=this.get_proper_image(),this.data.set("width",this.$el.width(),{silent:!0}),this.data.trigger("update"),i.isLocal=parseInt(i.isLocal,10),e.innerHTML=this.tpl(i),t(e).width(this.data.get("width")),t("<div>").html(e).html()},get_proper_image:function(){var t=this.data.toJSON(),e=t.imageFull,i=Upfront.Settings.LayoutEditor.Grid;return t.style=t.style||{image_col:0,group:"",image:"",caption:""},t.imageThumb&&t.style&&t.style.image&&t.style.image.col&&t.style.image.col*i.column_width<=t.imageThumb.width&&(e=t.imageThumb),e},getOutput:function(){var e=this.el.cloneNode(),i=this.data.toJSON();return i.image=this.get_proper_image(),!!i.image&&(this.data.set("width",this.$el.width(),{silent:!0}),this.data.trigger("update"),i.isLocal=parseInt(i.isLocal,10),e.innerHTML=this.tpl(i),t("<div>").html(e).html())},getImageData:function(t){if(!t)return!1;var e=t.at(0).toJSON(),i=this.getSelectedImage(e),a=this.is_wp?_.extend({},this.wp_defaults,{attachment_id:e.ID,caption:e.post_excerpt?e.post_excerpt:"",link_url:"",image:i,style:{caption:{show:!0},wrapper:{alignment:"alignnone",width:i.width},image:{size_class:"size-"+i.selected_size}}}):_.extend({},this.defaultData,{attachmentId:e.ID,title:e.post_tite,imageFull:e.image,imageThumb:this.getThumb(e.additional_sizes),selectedImage:_.isUndefined(e.selected_size)?e.image:_.filter(e.additional_sizes,function(t){var i=e.selected_size.toLowerCase().split("x"),a=i[0],n=i[1];return t.width==a&&t.height==n})[0],linkType:"do_nothing",linkUrl:"",align:"center"});return a},getThumb:function(t){var e={width:0};return _.each(t,function(t){t.width<=500&&t.width>e.width&&(e=t)}),e},getSelectedImage:function(t){if(t.image.selected_size="full","full"==t.selected_size)return t.image;var e=t.selected_size?t.selected_size.split("x"):[],i=["thumbnail","medium","large"];if(2!=e.length)return t.image;for(var a=0;a<t.additional_sizes.length;a++){var n=t.additional_sizes[a];if(n.selected_size=i[a],n.width==e[0]&&n.height==e[1])return n}return t.image},importInserts:function(e,i,a){var n=this,r={},o={};return remaining_images=e.find("img"),e.is(".wp-caption-text")||(this.$editor=e),n.importFromShortcode&&this.is_post_image_insert()&&(o=n.importFromShortcode(e,i,a)),this.is_post_image_insert()&&(remaining_images=e.find("img").filter(function(){return!t(this).closest(".ueditor-insert").length})),_.each(remaining_images,function(t){var e=!1;e=n.importFromImage(t),e&&(r[e.data.id]=e)}),_.extend(r,o)},importFromWrapper:function(t,e,i){var a=t.attr("id"),n=!1,r=ImageInsert;return _.contains(i,"postImage")&&(r=PostImageInsert),n=e[a]?new r({data:e[a]}):this.importFromImage(t.find("img")),n.render(),t.replaceWith(n.$el),n},getLinkView:function(){if(this.linkView)return this.linkView;var t=new n.LinkView({data:{linkType:this.data.get("linkType"),linkUrl:this.data.get("linkUrl")}});return this.linkView=t,t},getStyleView:function(){if(this.styleView)return this.styleView;var t=new n.PostImageStylesView(this.data);return this.styleView=t,t},calculateRealSize:function(t){var e=new Image;return e.src=t,{width:e.width,height:e.height}},generateThumbSrc:function(t,e){var i=this.data.get("imageFull").src,a=i.split("."),n=a.pop();return i=a.join(".")+"-"+t+"x"+e+"."+n},calculateImageResize:function(t,e){var i=e.width/e.height>t.width/t.height?"height":"width",a=e[i]/t[i],n={width:Math.round(e.width/a),height:Math.round(e.height/a)},r="width"==i;return n.top=r?-Math.round((n.height-t.height)/2):0,n.left=r?0:-Math.round((n.width-t.width)/2),n},render_shortcode:function(t){if(!this.is_image_insert()){t=t instanceof Backbone.Model?t.toJSON():t;var e=this.shortcode_tpl(t);e=e.replace(/\[caption[\s\S]+?\[\/caption\]/g,function(t){return t.replace(/<br([^>]*)>/g,"<wp-temp-br$1>").replace(/[\r\n\t]+/,"")}),e=e.replace(/\s*<div/g,"\n<div"),e=e.replace(/<\/div>\s*/g,"</div>\n"),e=e.replace(/\s*\[caption([^\[]+)\[\/caption\]\s*/gi,"\n\n[caption$1[/caption]\n\n"),e=e.replace(/caption\]\n\n+\[caption/g,"caption]\n\n[caption"),e=e.replace(/\s+/g," "),this.$shortcode_el.html(e)}},on_image_dragstart:function(t){t.preventDefault()},change_image:function(){var t=this;return Upfront.Media.Manager.open({multiple_selection:!1,insert_options:!1,button_text:r.change_image,hide_sizes:"image_insert"===this.data.get("insert_type")}).done(function(e,i){var a;_.isEmpty(i)||(t.start(i),t.$editor&&t.$editor.data("ueditor")&&(a=t.$editor.data("ueditor"),a.redactor.code.sync()))}),!1}});return{ImageInsertBase:o}})}(jQuery);