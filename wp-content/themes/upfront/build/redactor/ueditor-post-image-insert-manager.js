!function(t){upfrontrjs.define(["scripts/redactor/ueditor-insert","scripts/redactor/ueditor-image-insert-base","text!scripts/redactor/ueditor-templates.html","scripts/redactor/ueditor-image-insert-post"],function(e,i,r,n){var a=n.PostImageInsert,o=n.WP_PostImageInsert,s=i.ImageInsertBase.extend({start:function(e,i){var r=Upfront.Media.Manager.open({multiple_selection:!1,insert_options:!0}),n=t.Deferred();return r.done(function(t,e){var r;if(!_.isEmpty(e)){var s="wp_default"===e.at(0).get("insert_option");s?(r=new o({start:e,$editor:i}),n.resolve(r)):(r=new a({start:e,$editor:i}),n.resolve(r))}}),t.when(r,n.promise())},importFromShortcode:function(e,i){var r,n=this,a={};this.$editor=e;var o=wp.shortcode.replace("caption",e.html(),function(e){return e.parse_content=t.parseHTML(e.content),r=e.get("id").indexOf("uinsert-")!==-1?n.importFromShortcode_UF(e):n.importFromShortcode_WP(e),a[r.data.id]=r,r.el.outerHTML});return e.html(o),a},importFromShortcode_UF:function(e){var i=_.extend({},this.defaultData),r=this.calculateRealSize(i.imageThumb.src);t("<div>");i.imageThumb.src=this.get_shortcode_image_src(e.content),i.caption=this.get_shortcode_caption_text(e.parse_content),i=this.populate_link(e.content,i),i.imageFull={width:r.width,height:r.height,src:i.imageThumb.src},i.style=this._findVariant(e.get("uf_variant")).toJSON(),i.show_caption=parseInt(e.get("uf_show_caption"),10),i.style.caption.show=parseInt(e.get("uf_show_caption"),10),i.variant_id=i.style.vid;var n=new a({data:i,$editor:this.$editor});return n.render(),n},_findVariant:function(t){var e,i,r=Upfront.Content.ImageVariants.findWhere({vid:t});if(r)return r;if(e=Upfront.Content.PrevImageVariants.findWhere({vid:t})){if(e=e.toJSON(),r=Upfront.Content.ImageVariants.findWhere({label:e.label}))return r;if(r=Upfront.Content.ImageVariants.find(function(t){return t.get("group").float==e.group.float}))return r}if(i=Upfront.Content.OtherImageVariants.findWhere({vid:t})){if(i=i.toJSON(),r=Upfront.Content.ImageVariants.findWhere({label:i.label}))return r;if(r=Upfront.Content.ImageVariants.find(function(t){return t.get("group").float==i.group.float}))return r}return e&&(r=Upfront.Content.ImageVariants.find(function(t){return t.get("image").order==e.image.order}))?r:i&&(r=Upfront.Content.ImageVariants.find(function(t){return t.get("image").order==i.image.order}))?r:r=Upfront.Content.ImageVariants.first()},importFromShortcode_WP:function(e){var i=_.extend({},this.wp_defaults,{attachment_id:e.get("id").replace("attachment_",""),caption:this.get_shortcode_caption_text(t.parseHTML(e.content)),link_url:this.get_shortcode_url(e.content),image:{height:this.get_shortcode_content_image_height(e.content),width:e.get("width"),src:this.get_shortcode_image_src(e.content)},style:{caption:{show:parseInt(e.get("show_caption"),10)},wrapper:{alignment:e.get("align"),width:parseInt(e.get("width"),10)},image:{size_class:this.get_shortcode_content_image_size_class(e.content)}}}),r=new o({data:i,$editor:this.$editor});return r.render(),r},get_shortcode_image_src:function(e){return t("<div>").html(e).find("img").attr("src")},get_shortcode_caption_text:function(e){var i="",r=t("<div>");return _.each(e,function(e,n){t(e).is("img")||(i+=r.html(e).html())}),r.html(i).find("img").remove(),r.html()},get_shortcode_content_image_size_class:function(e){var i=/(?:^|\W)size-(\w+)(?!\w)/g,r=t("<div>").html(e).find("img"),n=!!r.length&&r.attr("class").match(i);return n?n[0]:""},get_shortcode_content_image_height:function(e){var i=t("<div>").html(e).find("img");return(i.length?i.attr("height"):"")||"auto"},populate_link:function(t,e){if(e.linkUrl=this.get_shortcode_url(t),!e.linkUrl)return e;var i=document.createElement("a");return i.href=e.linkUrl,i.origin!=window.location.origin&&(e.linkType="external"),i.origin==window.location.origin&&e.imageThumb.src!=e.linkUrl&&(e.linkType="post"),i.origin==window.location.origin&&e.imageThumb.src==e.linkUrl&&(e.linkType="show_larger_image"),e},get_shortcode_url:function(e){return t("<div>").html(e).find("a").attr("href")},get_image_size_class:function(t){var e=/(?:^|\W)size-(\w+)(?!\w)/g,i=!!t.className&&t.className.match(e);return i?i[0]:""},get_image_attachment_id:function(t){var e=/(?:^|\W)wp-image-(\w+)(?!\w)/g,i=!!t.className&&t.className.match(e);return i?i[0]:""},importFromImage:function(e){var i=t(e),r=_.extend({},this.wp_defaults,{attachment_id:this.get_image_attachment_id(e),caption:t.trim(i.attr("alt")),link_url:e.src,image:{height:parseInt(i.height(),10),width:parseInt(i.width(),10),src:e.src},style:{caption:{show:!1},wrapper:{alignment:"alignnone",width:parseInt(i.width(),10)},image:{size_class:this.get_image_size_class(e)}}}),n=new o({data:r,$editor:this.$editor});return n.render(),i.replaceWith(n.$el),n},importFromImage_prev:function(e){var i=_.extend({},this.defaultData),r={src:e.attr("src"),width:e.width(),height:e.height()},n=t("<a>").attr("href",r.src)[0],o=this.calculateRealSize(r.src),s=e.closest(".ueditor-insert-variant-group"),c=s.attr("class"),l=s.find(".wp-caption-text"),h=l.attr("class"),g=s.find(".uinsert-image-wrapper"),d=g.attr("class"),m=1;n.origin!=window.location.origin&&(i.isLocal=0),this.calculateRealSize(r.src),i.imageThumb=r,i.imageFull={width:o.width,height:o.height,src:r.src};var p=e.parent();p.is("a")&&(i.linkUrl=p.attr("href"),i.linkType="external");var f=e.attr("class");f?(f=f.match(/wp-image-(\d+)/),f?i.attachmentId=f[1]:i.attachmentId=!1):i.attachmentId=!1,i.title=e.attr("title"),_.isEmpty(l.text())||(i.caption=l.html()),m=l.prev(g).length?1:0,0===l.length&&(m=1),s.length?(i.style={caption:{order:m,height:l.css("minHeight")?l.css("minHeight").replace("px",""):l.height(),width_cls:Upfront.Util.grid.derive_column_class(h),left_cls:Upfront.Util.grid.derive_marginleft_class(h),top_cls:Upfront.Util.grid.derive_margintop_class(h),show:l.length},group:{float:s.css("float"),width_cls:Upfront.Util.grid.derive_column_class(c),left_cls:Upfront.Util.grid.derive_marginleft_class(c),height:s&&s.css("minHeight")?s.css("minHeight").replace("px",""):r.height+l.height(),marginRight:0,marginLeft:0},image:{width_cls:Upfront.Util.grid.derive_column_class(d),left_cls:Upfront.Util.grid.derive_marginleft_class(d),top_cls:Upfront.Util.grid.derive_margintop_class(d),src:"",height:0}},i.variant_id=s.data("variant")):(i.style=Upfront.Content.ImageVariants.first().toJSON(),i.variant_id=i.style.vid);var u=new a({data:i});return u.render(),e.replaceWith(u.$el),u}});return{PostImageInsert_Manager:s}})}(jQuery);