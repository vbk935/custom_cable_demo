!function(t){var e=function(t){var e,s=(new Date).getTime(),i=Math.max(0,16-(s-e)),a=setTimeout(function(){t(s+i)},i);return e=s+i,a},s=function(t){return"undefined"!=typeof Upfront&&Upfront.Util?Upfront.Util.colors.rgba_to_rgb(t):t.replace(/ /g,"").replace(/^rgba\((\d+)\,(\d+)\,(\d+)\,(\d+\.?\d{0,}?)\)$/,"rgb($1, $2, $3)")},i=t.proxy(window.requestAnimationFrame,window)||t.proxy(window.webkitRequestAnimationFrame,window)||t.proxy(window.mozRequestAnimationFrame,window)||t.proxy(window.oRequestAnimationFrame,window)||t.proxy(window.msRequestAnimationFrame,window)||e;t.fn.uparallax=function(e){var i,o="string"==typeof e,n=o?Array.prototype.slice.call(arguments,1):[];return this.each(function(){var h=t(this),c=h.data("uparallax");c?o&&(i=c.callMethod(e,n)):o?t.error("Can't call the method "+e+". The object is not initialized"):(e.bgColor=s(h.parent().css("background-color")),h.data("uparallax",new a(h,e)))}),1==this.length&"undefined"!=typeof i?i:this};var a=function(e,s){var i=t.extend({autostart:!0,element:"",effect:"scroll",movement:30,rotation:15,scaling:1.1,opacity:.5,renderer:this.getDefaultRenderer(),overflowTop:100,overflowBottom:100,bgColor:"#fff"},s);this.opts=i,this.$parent=e.parent(),this.$element=e,this.$moveElement="string"==typeof this.opts.element?e.find(this.opts.element):this.opts.element,a.id++,this.id=a.id,a.instances[this.id]=this,this.opts.autostart&&this.start()};a.id=0,a.instances={},a.prevTime=0,a.started=!1,a.cache={lastScrollTop:-1,scrollTop:0,winHeight:0,scrollBottom:0},a.canvas=!1,a.context=!1,a.start=function(){a.started||(a.started=!0,a.draw())},a.draw=function(e){var s=a.cache.scrollTop;if(a.cache.lastScrollTop==s&&e-a.prevTime<5e3)return void i(a.draw);var o=t(window).height(),n=Math.round(s+o);a.cache.lastScrollTop=s,a.cache.winHeight=o,a.cache.scrollBottom=n;for(var h in a.instances)a.instances[h].draw(e);a.prevTime=e,i(a.draw)},a.updateScroll=function(t){var e=window.pageYOffset;a.cache.scrollTop=e},t(window).one("load.upfront_paralax",a.updateScroll),t(window).on("load.upfront_paralax",a.draw),t(window).on("scroll.upfront_paralax",a.updateScroll),a.prototype={cache:{},canvas:!1,context:!1,imgCanvas:!1,imgContext:!1,callMethod:function(t,e){switch(t){case"start":this.start();break;case"stop":this.stop();break;case"destroy":this.destroy();break;case"refresh":this.refresh();break;case"setOption":this.setOption(e[0],e[1]);break;case"setEffect":this.setOption("effect",e[0]);break;case"setMovement":this.setOption("movement",e[0]);break;case"setOpacity":this.setOption("opacity",e[0]);break;case"setRotation":this.setOption("rotation",e[0]);break;case"setScaling":this.setOption("scaling",e[0])}},bindEvents:function(){t(window).on("load.upfront_parallax_"+this.id,t.proxy(this.refresh,this)),t(window).on("resize.upfront_parallax_"+this.id,t.proxy(this.refresh,this))},unbindEvents:function(){t(window).off("load.upfront_parallax_"+this.id),t(window).off("resize.upfront_parallax_"+this.id)},setOption:function(t,e){this.opts[t]=e,this.refresh()},getDefaultRenderer:function(){return"canvas"},start:function(){this.$element.addClass("upfront-parallax"),this.$moveElement.addClass("upfront-parallax-element"),this.reset_cache(),"fixed"==this.opts.renderer?this.prepareFixedPos():"canvas"==this.opts.renderer&&this.prepareCanvas(),this.refresh(),this.bindEvents(),a.start()},stop:function(){this.$element.removeClass("upfront-parallax"),this.$moveElement.removeClass("upfront-parallax-element"),"fixed"==this.opts.renderer?this.restorePos():"canvas"==this.opts.renderer&&this.removeCanvas(),this.reset(),this.unbindEvents()},reset_cache:function(){this.cache={translate:0,offsetTop:0,offsetBottom:0,offsetLeft:0,height:0,width:0,visible:!0,img:!1,imgCanvas:!1,imgContext:!1}},reset:function(){this.$moveElement.css({transform:"",opacity:"",top:"",bottom:""})},destroy:function(){this.stop(),delete a.instances[this.id],this.$element.removeData("uparallax")},prepareFixedPos:function(){this.$element.css({position:"fixed",top:0,left:0})},restorePos:function(){this.$element.css({position:"",top:"",left:"",transform:""})},prepareCanvas:function(){this.canvas===!1&&(this.canvas=document.createElement("canvas"),this.canvas.id="uparallax-"+this.id,t(this.canvas).css({position:"fixed",top:0,left:0,zIndex:-1,display:"block",pointerEvents:"none"}),t(".upfront-output-layout, .upfront-layout").append(this.canvas)),this.context=this.canvas.getContext("2d"),this.is_image_png()&&(this.context.fillStyle=this.opts.bgColor),this.updateCanvas()},updateCanvas:function(){this.canvas!==!1&&(this.canvas.width=t(window).width(),this.canvas.height=t(window).height())},removeCanvas:function(){t(this.canvas).remove()},prepareImage:function(){if(this.cache.img)return this.imgCanvas||this.renderImage(),void this.$element.css("display","none");var t=new Image,e=this.$moveElement.css("background-image").replace(/^url\(\s*['"]?\s*/,"").replace(/\s*['"]?\s*\)$/,""),s=this.$moveElement.css("background-position").split(" ");this.size_percentage=.01*parseInt(this.$moveElement.css("background-size"),10),this.percent_x=.01*parseInt(s[0],10),this.percent_y=.01*parseInt(s[1],10),isNaN(this.size_percentage)&&(this.size_percentage=1,this.percent_x=.5,this.percent_y=.5),"none"!=e&&(this.cache.img=t,this.cache.background_color=this.$parent.css("background-color")||"#fff",t.src=e,this.$element.css("display","none"),this.$parent.css({background:"none"}))},renderImage:function(){if(this.cache.img){this.imgCanvas||(this.imgCanvas=document.createElement("canvas"),t(this.imgCanvas).css({display:"block"}),this.imgContext=this.imgCanvas.getContext("2d",{alpha:!1}));var e=this.cache.width,s=this.cache.height,i=s+2*this.movementOffset,o=(a.cache.winHeight,this.cache.img.height/this.cache.img.width),n=e,h=i,c=0,r=0,f=0,l=0,p=0;this.imgCanvas.width=e,this.imgCanvas.height=i,i/e>o?(n=i/o,r=Math.floor(e/n*this.cache.img.width)):(h=e*o,r=this.cache.img.width),c=(s-h)/2,f=Math.floor(i/h*this.cache.img.height),l=(this.cache.img.width-r)/2,p=(this.cache.img.height-f)/2,scale=this.size_percentage,position_x=-.5*e*scale+e*scale*this.percent_x,position_y=-.5*s*scale+s*scale*this.percent_y,this.is_image_png()&&this.fillCanvas(e,i);try{this.imgContext.drawImage(this.cache.img,l,p,r,f,position_x,position_y,e*scale,i*scale)}catch(t){Upfront.Util.log("Broken image provided for Parallax")}}},refresh:function(){this.refreshCache();var e=this.cache.height,s=t(window).height(),i=Math.round((s-e)/2);i-this.opts.movement>this.opts.movement?this.movementOffset=i-this.opts.movement:this.movementOffset=this.opts.movement,this.$moveElement.css({top:this.movementOffset*-1,bottom:this.movementOffset*-1}),"fixed"==this.opts.renderer?this.$element.css({left:this.cache.offsetLeft,height:this.cache.height,width:this.cache.width}):"canvas"==this.opts.renderer&&(this.updateCanvas(),this.renderImage()),this.update()},refreshCache:function(){var t=this.$parent.offset(),e=this.$parent.height(),s=this.$parent.width();this.cache.offsetTop=t.top,this.cache.offsetBottom=t.top+e,this.cache.offsetLeft=t.left,this.cache.height=e,this.cache.width=s},update:function(){i(t.proxy(this.draw,this))},draw:function(t){if(this.id in a.instances){var e=this.cache.offsetTop,s=this.cache.offsetBottom,i=this.cache.height,o=a.cache.scrollTop,n=a.cache.scrollBottom,h=a.cache.winHeight,c=2*this.movementOffset+2*this.opts.movement,r=2*this.movementOffset,f=this.movementOffset>0?r/c:1,l=Math.round(f*(n-e-i))-this.movementOffset,p=Math.round(f*h)-this.movementOffset,m=p*-1,d=this.opts.effect.split(","),v="";if(("canvas"!=this.opts.renderer||(this.prepareImage(),this.cache.img))&&(s>o&&e<n?("fixed"==this.opts.renderer&&(this.cache.visible||this.$element.css("visibility","visible"),this.$element.css({transform:"translateY("+(e-o)+"px)"})),this.cache.visible=!0):this.cache.visible&&("fixed"==this.opts.renderer?this.$element.css({visibility:"hidden"}):"canvas"==this.opts.renderer&&this.clearCanvas(),this.cache.visible=!1),l>p?l=p:l<m&&(l=m),this.cache.visible))if(this.cache.translate=l,"canvas"==this.opts.renderer)this.drawCanvas(l,p);else{for(var g in d){var u=this.getEffect(d[g],l,p);"transform"==u.property?(v+=""==v?"":" ",v+=u.value):this.$moveElement.css(u.property,u.value)}""!==v&&this.$moveElement.css("transform",v)}}},drawCanvas:function(t,e){if(this.cache.img&&this.imgCanvas){var s=this.cache.offsetTop,i=this.cache.offsetBottom,o=this.cache.offsetLeft,n=this.cache.width,h=this.cache.height,c=h+2*this.movementOffset,r=a.cache.scrollTop,f=a.cache.scrollBottom,l=a.cache.winHeight,p=h,m=(this.cache.img.height/this.cache.img.width,0),d=0,v=this.findClosestInstances(),g=s,u=i;s<r?p=i-r:i>f&&(p=f-s),p=Math.min(l,p),m=c>h?Math.round((c-h)/2):0,s<r&&(d=r-s,m+=d),m+=t*-1,v.top&&v.top.cache.offsetBottom<s?g-=Math.min(this.opts.overflowTop,Math.ceil((s-v.top.cache.offsetBottom)/2)):v.top||(g-=this.opts.overflowTop),v.bottom&&v.bottom.cache.offsetTop>i?u+=Math.min(this.opts.overflowBottom,Math.floor((v.bottom.cache.offsetTop-i)/2)):v.bottom||(u+=this.opts.overflowBottom),this.context.drawImage(this.imgCanvas,0,0,n,c,o,s-this.movementOffset-r+t,n,c),g>r&&this.context.clearRect(o,0,n,g-r),l>u-r&&this.context.clearRect(o,u-r,n,l-(u-r))}},is_image_png:function(){return this.cache.img&&this.cache.img.src&&this.cache.img.src.toLowerCase().match(/.png/)},fillCanvas:function(t,e){this.imgContext.fillStyle=this.opts.bgColor,this.imgContext.rect(0,0,t,e),this.imgContext.fill()},clearCanvas:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},findClosestInstances:function(){var t=!1,e=!1,s=!1;for(var i in a.instances)if(t=a.instances[i],t.id!=this.id)if(t.cache.offsetBottom<=this.cache.offsetTop){if(e!==!1&&e.cache.offsetBottom>t.cache.offsetBottom)continue;e=t}else if(t.cache.offsetTop>=this.cache.offsetBottom){if(s!==!1&&s.cache.offsetTop<t.cache.offsetTop)continue;s=t}return{top:e,bottom:s}},getEffect:function(t,e,s){var i="transform",a="",o=e/s;switch(t){case"scroll":a="translateY("+e+"px)";break;case"rotate":a="rotate("+o*this.opts.rotation+"deg)";break;case"scale":a="scale("+(1-(1-this.opts.scaling)*Math.abs(o))+")";break;case"opacity":i="opacity",a=1-(1-this.opts.opacity)*Math.abs(o)}return{property:i,value:a}}}}(jQuery);