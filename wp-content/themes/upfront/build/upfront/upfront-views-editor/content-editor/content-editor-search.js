!function(e){Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;upfrontrjs.define(["text!upfront/templates/popup.html","scripts/upfront/upfront-views-editor/fields"],function(t,n){return Backbone.View.extend({id:"upfront-entity_list-search",searchTpl:_.template(e(t).find("#upfront-filter-tpl").html()),events:{"click #upfront-search_action":"handle_search_request","click #upfront-search_container button":"clear_search","click .upfront-search-results-header button":"clear_search","keydown #upfront-list-search_input":"dispatch_search_enter"},initialize:function(e){this.postType=e.postType},render:function(){var e=!!this.collection.lastFetchOptions&&this.collection.lastFetchOptions.search,t=this.get_placeholder();this.$el.html(this.searchTpl({query:e,placeholder:t})),this.add_filter_dropdowns()},get_placeholder:function(){return"post"===this.postType?Upfront.Settings.l10n.global.content.search_posts:"page"===this.postType?Upfront.Settings.l10n.global.content.search_pages:Upfront.Settings.l10n.global.content.search_cpts},dispatch_search_enter:function(e){if(13==e.which)return this.handle_search_request(e)},handle_search_request:function(e){e.preventDefault();var t=this.$el.find("#upfront-search_container input").val();this.toggle_search_class(t),this.collection.fetch({search:t})},handle_filter_request:function(){var e=this.status?this.status:"any",t=!!this.date&&this.date,n=!!this.category&&this.category,s=this.post_type&&"any"!==this.post_type?this.post_type:this.postType;this.collection.fetch({post_status:e,m:t,cat:n,postType:s}),this.toggle_search_class("")},toggle_search_class:function(e){""===e?this.$el.parent().removeClass("upfront-popup-content-search-ran"):this.$el.parent().addClass("upfront-popup-content-search-ran")},update_search_header:function(e){this.$el.find(".upfront-search-results-header #upfront-search-results-count").html()},clear_search:function(e){return e.preventDefault(),this.$el.find("#upfront-search_container input").val(""),this.toggle_search_class(""),"page"===this.collection.postType?this.collection.fetch({search:"",hierarchical:!0}):this.collection.fetch({search:""})},get_status_values:function(e){return _.mapObject(e,function(e){return"undefined"==typeof e.value&&(e.value=e.name),e})},get_pt_values:function(e){return e},get_date_values:function(e){return e},get_category_values:function(e){return _.mapObject(e,function(e){return"undefined"==typeof e.value&&(e.value=e.term_id),"undefined"==typeof e.label&&(e.label=e.name),e})},add_filter_dropdowns:function(){var t=this,n=this.collection.filtering;return e(t.el).find("#upfront-list-filter-dropdowns-container").empty(),"post"===t.postType||"page"===t.postType?t.normal_filter_dropdowns(n):t.cpt_filter_dropdowns(n)},normal_filter_dropdowns:function(e){var t=this,s=t.collection.lastFetchOptions,r=s.post_status?s.post_status:"any",o=!!s.m&&s.m,a=!!s.cat&&s.cat,l=new n.Select({model:t.model,name:"upfront_post_status_filter",default_value:r?r:"any",values:t.get_status_values(e.statuses),change:function(e){t.status=e,t.handle_filter_request()}}),i=new n.Select({model:t.model,name:"upfront_post_date_filter",default_value:o?o:0,values:t.get_date_values(e.dates),change:function(e){t.date=e,t.handle_filter_request()}}),p=new n.Select({model:t.model,name:"upfront_post_category_filter",default_value:a?a:0,values:t.get_category_values(e.categories),change:function(e){t.category=e,t.handle_filter_request()}});t.filter_dropdowns=[l,i,p],l.render(),i.render(),p.render(),t.$el.find("#upfront-list-filter-dropdowns-container").append(l.$el),t.$el.find("#upfront-list-filter-dropdowns-container").append(i.$el),t.$el.find("#upfront-list-filter-dropdowns-container").append(p.$el)},cpt_filter_dropdowns:function(e){var t=this,s=t.collection.lastFetchOptions,r=s.postType&&"object"!=typeof s.postType?s.postType:"any",o=!!s.m&&s.m,a=new n.Select({model:t.model,name:"upfront_post_types_filter",default_value:r?r:"any",values:t.get_pt_values(e.post_types),change:function(e){t.post_type=e,t.handle_filter_request()}}),l=new n.Select({model:t.model,name:"upfront_post_date_filter",default_value:o?o:0,values:t.get_date_values(e.dates),change:function(e){t.date=e,t.handle_filter_request()}});t.filter_dropdowns=[a,l],a.render(),l.render(),t.$el.find("#upfront-list-filter-dropdowns-container").append(a.$el),t.$el.find("#upfront-list-filter-dropdowns-container").append(l.$el)}})})}(jQuery);