!function(t){Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;upfrontrjs.define(["text!upfront/templates/popup.html"],function(e){return Backbone.View.extend({events:{"click #upfront-list-meta .upfront-list_item-component":"handle_sort_request","mouseenter .upfront-list_item-comment":"start_reveal_counter","mouseleave .upfront-list_item-comment":"stop_reveal_counter","click .upfront-list_item-comment":"toggle_full_post","click .upfront-comments-approve":"handle_approval_request","click .upfront-comment_actions-wrapper a":"handle_action_bar_request","click .comment-edit-ok":"edit_comment","click .comment-reply-ok":"reply_to_comment","click .comment-reply-cancel":"cancel_edit","click .comment-edit-box":"stop_propagation"},excerptLength:60,commentsTpl:_.template(t(e).find("#upfront-comments-tpl").html()),commentTpl:_.template(t(e).find("#upfront-comment-single-tpl").html()),initialize:function(t){this.collection.on("change",this.renderComment,this),this.collection.on("add",this.addComment,this)},render:function(){var t=0==this.collection.postId?[]:this.collection.getPage(this.collection.pagination.currentPage);this.$el.html(this.commentsTpl({comments:t,excerptLength:45,commentTpl:this.commentTpl,orderby:this.collection.orderby,order:this.collection.order}))},renderComment:function(t){this.$("#upfront-list_item-comment-"+t.get("comment_ID")).html(this.commentTpl({comment:t,excerptLength:60}))},addComment:function(e){var n=e.get("comment_parent"),o=e.get("comment_ID"),i=t('<div class="upfront-list_item-comment upfront-list_item clearfix expanded" id="upfront-list_item-comment-'+o+'" data-comment_id="'+o+'">'+this.commentTpl({comment:e,excerptLength:this.excerptLength})+"</div>").hide();this.$("div.upfront-list_item-comment").removeClass("expanded"),this._currently_working=!1,n?this.$("#upfront-list_item-comment-"+n).after(i):this.$("div.upfront-list-comment-items").append(i),i.slideDown()},handle_sort_request:function(e){var n=t(e.target).closest(".upfront-list_item-component"),o=n.attr("data-sortby"),i=this.collection.order;o&&(o==this.collection.orderby&&(i="desc"==i?"asc":"desc"),this.collection.reSort(o,i))},start_reveal_counter:function(e){var n=this;return!t(e.target).is(".upfront-comment-approved")&&!t(e.target).parents(".upfront-comment-approved").length&&(!this._currently_working&&(clearTimeout(n._reveal_counter),void(n._reveal_counter=setTimeout(function(){n.reveal_comment(e)},500))))},reveal_comment:function(e){this.$(".upfront-list-comments .upfront-list_item").removeClass("expanded"),t(e.currentTarget).addClass("expanded"),clearTimeout(this._reveal_counter)},revert_comment:function(e){t(e.currentTarget).removeClass("expanded"),clearTimeout(this._reveal_counter)},toggle_full_post:function(e){t(e.currentTarget).toggleClass("expanded")},stop_reveal_counter:function(t){return!this._currently_working&&void this.revert_comment(t)},handle_approval_request:function(e,n){n=n?n:this.collection.get(t(e.target).attr("data-comment_id")),this.$("#upfront-list_item-comment-"+n.id+" i.upfront-comments-approve").animate({"font-size":"1px",opacity:0},400,"swing",function(){n.approve(!0).save()})},handle_action_bar_request:function(e){var n=t(e.currentTarget),o=this.collection.get(n.parents(".upfront-list_item-comment").attr("data-comment_id"));return n.is(".edit")?this._edit_comment(o):n.is(".reply")?this._reply_to_comment(o):n.is(".approve")?this.handle_approval_request(!1,o):n.is(".unapprove")?o.approve(!1).save():n.is(".thrash")?o.trash(!0).save():n.is(".unthrash")?o.trash(!1).save():n.is(".spam")?o.spam(!0).save():n.is(".unspam")&&o.spam(!1).save(),!1},edit_comment:function(e){var n=t(e.target).parent(),o=this.collection.get(n.attr("data-comment_id"));o.set("comment_content",n.find("textarea").attr("disabled",!0).val()).save()},reply_to_comment:function(e){var n=this,o=t(e.target).parent(),i=this.collection.get(o.attr("data-comment_id")),r=this.$("#upfront-list_item-comment-"+i.get("comment_ID")),m=o.find("textarea").val(),c=Upfront.data.currentUser;if(m){var a=new Upfront.Models.Comment({comment_author:c.get("data").display_name,comment_post_ID:this.collection.postId,comment_parent:i.get("comment_ID"),comment_content:m,comment_approved:"1",user_id:c.get("ID")});(new Date).getTime();r.find("textarea").attr("disabled",!0),a.save().done(function(t){n.renderComment(i),a.set("comment_ID",t.data.comment_ID),n.collection.add(a),n.$("#upfront-list_item-comment-"+t.data.comment_ID).hide().slideDown()})}},cancel_edit:function(e){var n=t(e.target).parent(),o=this.collection.get(n.attr("data-comment_id"));this.renderComment(o)},stop_propagation:function(t){t.stopPropagation()},_edit_comment:function(t){var e=this.$("#upfront-list_item-comment-"+t.get("comment_ID"));e.find(".upfront-comment_togglable").hide(),e.find(".upfront-comment_edit").show(),this._currently_working=!0},_reply_to_comment:function(t){var e=this.$("#upfront-list_item-comment-"+t.get("comment_ID"));e.find(".upfront-comment_togglable").show(),e.find(".upfront-comment_edit").hide(),this._currently_working=!0}})})}(jQuery);