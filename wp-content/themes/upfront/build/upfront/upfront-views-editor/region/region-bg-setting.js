!function(t){var n=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;upfrontrjs.define(["scripts/upfront/upfront-views-editor/modal-bg-setting","scripts/upfront/upfront-views-editor/fields","text!upfront/templates/region_edit_panel.html","scripts/perfect-scrollbar/perfect-scrollbar"],function(i,o,r,s){return i.extend({events:{"click .upfront-inline-modal-cancel":"on_click_cancel","click .upfront-inline-modal-content":"on_click_content","click .uf-settings-panel__title":"toggle_advanced_settings","click .upfront-inline-modal-save":"on_click_save"},reset_models:function(){if("undefined"!=typeof this.oldData){var e=this.model.get("properties").models,t=this.oldData;this.revert_models_to_previous(e,t)}},revert_models_to_previous:function(e,t){e.map(function(e,n){var i=t[n];i&&"undefined"!=typeof i.name&&(e.set("name",i.name),e.set("value",i.value))})},save_current_models:function(){var e=[],t=this.model.get("properties").models;t.map(function(t){e.push(_.clone(t.attributes))}),this.oldData=e},render_modal:function(e,n){var i=this.get_template(),o=i();e.find(".upfront-region-bg-setting-tab-primary, .upfront-region-bg-setting-tab-secondary").children().detach(),e.html(o),n.addClass("upfront-region-modal-bg"),this.render_header_settings(e.find(".upfront-region-bg-setting-header")),this.render_main_settings(e),this.render_footer_settings(e.find(".upfront-region-bg-setting-footer")),this.render_bg_type_settings(e),this.render_padding_settings(e.find(".upfront-region-bg-setting-padding"));var r=this.$el.find(".uf-region-bg-settings-panel-content");r=r[0]||!1,r&&(this.set_settings_content_max_height(),s.withDebounceUpdate(r,!0,"region:background:type:changed",!0),Upfront.Events.on("color:spectrum:show",function(){t(r).css("position","initial")}),Upfront.Events.on("color:spectrum:hide",function(){t(r).css("position","relative")})),"region-settings-sidebar"===this.$el.parent().attr("id")&&this.save_current_models()},set_settings_content_max_height:function(){var e=this.$el.height(),t=this.$el.find(".upfront-region-bg-setting-header").first().outerHeight(!0),n=this.$el.find(".upfront-settings_panel.advanced-settings").first().outerHeight(!0);this.$el.find(".uf-region-bg-settings-panel-content").css("max-height",e-t-n-70+"px")},close:function(e){return i.prototype.close.call(this,e)},get_template:function(){var e=t(r);return _.template(e.find("#upfront-region-bg-setting").html())},get_bg_types:function(){var e=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),t=this.model.get_property_value_by_name("background_type"),i=[{label:n.solid_color,value:"color"},{label:n.image,value:"image"},{label:n.video,value:"video"},{label:n.image_slider,value:"slider"},{label:n.map,value:"map"}];return e&&!e.default&&i.unshift({label:n.inherit,value:"",icon:t?t:"color"}),(_upfront_post_data.post_id||!0===Upfront.plugins.isRequiredByPlugin("show feature image region type")&&Upfront.Application.is_single())&&(Upfront.Application.is_single("404_page")||i.push({label:n.featured_image,value:"featured"})),i},get_region_types:function(e){var t=[{label:n.full_width,value:"wide"},{label:n.contained,value:"clip"}];return e>0?t:_.union([{label:n.full_screen,value:"full"}],t)},render_header_settings:function(e){var i=this,s=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),l=s&&!s.default,a=!this.model.is_main()&&this.model.get("sub"),g=t(r),d=_.template(g.find("#upfront-region-bg-setting-name").html()),p=new o.Text({model:this.model,name:"title",placeholder:n.region_name_placeholder,compact:!0,change:function(){},blur:function(){var e,n,o,r=this.model.collection,s=this.model.get("title"),l=(this.model.get("name"),t.trim(this.get_value().replace(/[^A-Za-z0-9\s_-]/g,""))),a=l.toLowerCase().replace(/\s/g,"-");s!=l&&(r.get_by_name(a)&&(e=r.get_new_title(l+" ",2),l=e.title,a=e.name),o=i.get_region_css_styles(this.model),this.model.is_main()?(n=this.model.get_sub_regions(),_.each(n,function(e,t){_.isArray(e)?_.each(e,function(e){e.set({container:a},{silent:!0})}):_.isObject(e)&&e.set({container:a},{silent:!0})}),this.model.set({title:l,name:a,container:a},{silent:!0})):this.model.set({title:l,name:a},{silent:!0}),f.find(".upfront-region-name-edit-value").text(l),i.set_region_css_styles(this.model,o.styles,o.selector),this.model.get("properties").trigger("change"))},rendered:function(){var e=this;this.get_field().on("keyup",function(t){13===t.which&&e.trigger("blur")})}}),c=new o.Button({model:this.model,name:"scope",classname:"upfront-region-bg-setting-globalize",label:n.make_global,compact:!0,on_click:function(){i.apply_region_scope(this.model,"global"),h.show(),f.find(".upfront-region-bg-setting-is-global").show(),u.$el.show(),this.$el.hide()}}),u=new o.Button({model:this.model,name:"localize",label:n.localize_region,classname:"upfront-region-bg-setting-localize",compact:!0,on_click:function(){i.apply_region_scope(this.model,"local"),h.show(),f.find(".upfront-region-bg-setting-is-global").hide(),c.$el.show(),this.$el.hide()},rendered:function(){this.$el.attr("title",n.localize_region_info)}}),m=new o.Button({model:this.model,name:"save",label:n.ok.toLowerCase(),compact:!0,classname:"upfront-region-bg-setting-name-save",on_click:function(){f.find(".upfront-region-bg-setting-name-wrap").show(),h.show(),f.find(".upfront-region-bg-setting-name-edit").hide(),i.toggle_editable_region_panels(!0),"global"==this.model.get("scope")?(c.$el.hide(),u._no_display||u.$el.show()):c.$el.show()}}),f=e.find(".upfront-region-bg-setting-name"),h=e.parent().find(".upfront-region-bg-setting-auto-resize");if(l)return void e.hide();if(f.append(d()),p.render(),c.render(),u.render(),m.render(),f.find(".upfront-region-bg-setting-name-edit").append([p.$el,m.$el,c.$el,u.$el]).hide(),f.find(".upfront-region-name-edit-value").text(this.model.get("title")),"global"==this.model.get("scope")){if(f.find(".upfront-region-bg-setting-is-global").show(),c.$el.hide(),!this.model.is_main()&&a){var b=this.model.collection.get_by_name(this.model.get("container"));b&&"global"==b.get("scope")&&(u.$el.hide(),u._no_display=!0)}}else f.find(".upfront-region-bg-setting-is-global").hide(),u.$el.hide();f.on("click",".upfront-region-name-edit-trigger",function(e){e.preventDefault(),f.find(".upfront-region-bg-setting-name-wrap").hide(),h.hide(),i.toggle_editable_region_panels(!1),f.find(".upfront-region-bg-setting-name-edit").show(),"global"!=i.model.get("scope")?p.get_field().prop("disabled",!1).trigger("focus").select():p.get_field().prop("disabled",!0)}),this.model.is_main()?this.render_expand_lock(h):h.hide()},toggle_editable_region_panels:function(e){return e?t(".upfront-bg-setting-type, .upfront-region-bg-setting-region-style-container, .upfront-region-bg-setting-footer, .upfront-bg-setting-tab, .upfront-region-bg-setting-padding").css({pointerEvents:"auto",opacity:1}):t(".upfront-bg-setting-type, .upfront-region-bg-setting-region-style-container, .upfront-region-bg-setting-footer, .upfront-bg-setting-tab, .upfront-region-bg-setting-padding").css({pointerEvents:"none",opacity:.5})},render_main_settings:function(e){var t=this,i=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),r=i&&!i.default,s=this.model.collection,l=s.indexOf(this.model),a=s.index_container(this.model,["shadow","lightbox"]),g=(s.total_container(["shadow","lightbox"]),new o.Select({model:this.model,name:"type",default_value:"wide",label:n.region_style,layout:"horizontal-inline",values:this.get_region_types(a),change:function(){var e=this.get_value();this.model.set({type:e},{silent:!0}),"full"==e?(m.show(),f.show(),this.model.set({sticky:0},{silent:!0})):(m.hide(),f.hide()),this.model.get("properties").trigger("change"),t.update_pos(),Upfront.Events.trigger("command:region:edit_toggle",!1),Upfront.Events.trigger("command:region:edit_toggle",!0)}})),d=this.model.get_property_value_by_name("nav_region"),p=new o.Toggle({model:this.model,property:"sub_regions",default_value:this.model.get_property_value_by_name("sub_regions")?[]:[d],layout:"horizontal-inline",multiple:!0,values:[{label:n.sub_top,value:"top"},{label:n.sub_bottom,value:"bottom"}],change:function(){var e=this.get_value(),n=t.model.get_sub_regions(),i=!1;l=s.indexOf(t.model),!_.contains(e,"top")&&n.top&&(i=Upfront.Util.model_to_json(n.top),t._sub_region_top_copy=new Upfront.Models.Region(i),s.remove(n.top)),!_.contains(e,"bottom")&&n.bottom&&(i=Upfront.Util.model_to_json(n.bottom),t._sub_region_bottom_copy=new Upfront.Models.Region(i),s.remove(n.bottom)),_.each(e,function(e){if(!n[e]){var i=!1,o=!1;if("bottom"==e?(t._sub_region_bottom_copy&&(o=t._sub_region_bottom_copy),i=n.right?l+2:l+1):"top"==e&&(t._sub_region_top_copy&&(o=t._sub_region_top_copy),i=n.left?l-1:l),i!==!1){var r=t.model.get("name")+"_"+e,a=t.model.get("title")+" "+e;o===!1&&(o=new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args),{name:r,title:a,container:t.model.get("name"),sub:e,scope:t.model.get("scope")}))),o.add_to(s,i,{sub:e}),Upfront.Events.trigger("command:region:edit_toggle",!0)}}}),this.property.set({value:e})}}),c=new o.Radios({model:this.model,name:"behavior",default_value:"keep-position",layout:"horizontal-inline",values:[{label:n.keep_position,value:"keep-position"},{label:n.keep_ratio,value:"keep-ratio"}],change:function(){var e=this.get_value();this.model.set({behavior:e},{silent:!0}),this.model.get("properties").trigger("change")}}),u=e.find(".upfront-region-bg-setting-region-type"),m=e.find(".upfront-region-bg-setting-region-nav"),f=e.find(".upfront-region-bg-setting-region-behavior");!r&&this.model.is_main()?(g.render(),u.append(g.$el),p.render(),m.append(p.$el),c.render(),f.append(c.$el)):(u.hide(),m.hide(),f.hide()),this.model.is_main()&&(this.listenTo(g,"changed",function(){t.render_expand_lock(e.find(".upfront-region-bg-setting-auto-resize"))}),r||g.trigger("changed"))},render_footer_settings:function(e){var t=this,n=Upfront.Views.breakpoints_storage.get_breakpoints().get_active().toJSON(),i=n&&!n.default,o=(!this.model.is_main()&&this.model.get("sub"),e.find(".upfront-region-bg-setting-sticky"));i?o.hide():(this.render_sticky_settings(o),e.find(".upfront-region-bg-setting-edit-css").on("click",function(e){e.preventDefault(),e.stopPropagation(),t.trigger_edit_css()}),e.find(".upfront-region-bg-setting-trash").on("click",function(e){e.preventDefault(),e.stopPropagation(),t.trigger_trash()}))},render_sticky_settings:function(e){var t=this.model.collection,i=t.findWhere({sticky:"1"}),r=new o.Toggle({model:this.model,name:"sticky",default_value:"",layout:"horizontal-inline",values:[{label:n.sticky_region,value:"1"}],change:function(){var e=this.get_value();this.model.set({sticky:e},{silent:!0}),this.model.get("properties").trigger("change")},multiple:!1});!i&&this.for_view.$el.height()<=300||this.model.get("sticky")?(r.render(),r.$el.find("label").append('<span class="upfront-bg-setting-sticky-toggle"></span>'),e.append(r.$el)):e.hide()},render_padding_settings:function(e){var i,s,l,a,g=t(r),d=_.template(g.find("#upfront-region-bg-setting-padding").html()),p=new o.Checkboxes({model:this.model,use_breakpoint_property:!0,property:"bg_padding_type",label:"",values:[{label:" ",value:"varied"},{label:n.equal_padding,value:"equal"}],multiple:!1,default_value:this.model.get_breakpoint_property_value("bg_padding_type")||"equal",change:function(){this.model.set_breakpoint_property("bg_padding_type",this.get_value())},show:function(n,i){"varied"===n?(t(".upfront-region-bg-setting-padding-top",e).show(),t(".upfront-region-bg-setting-padding-bottom",e).show(),t(".upfront-region-bg-setting-equal-padding",e).hide()):(t(".upfront-region-bg-setting-equal-padding",e).show(),t(".upfront-region-bg-setting-padding-top",e).hide(),t(".upfront-region-bg-setting-padding-bottom",e).hide())}}),c=new o.Number({model:this.model,use_breakpoint_property:!0,property:"top_bg_padding_num",label:"",default_value:this.model.get_breakpoint_property_value("top_bg_padding_num")||0,prefix:n.bottom_padding,suffix:n.px,min:0,step:5,change:function(){var e=this.get_value();this.model.set_breakpoint_property("top_bg_padding_num",e)}}),u=new o.Number({model:this.model,use_breakpoint_property:!0,property:"bottom_bg_padding_num",label:"",default_value:this.model.get_breakpoint_property_value("bottom_bg_padding_num")||0,suffix:n.px,min:0,step:5,change:function(){var e=this.get_value();this.model.set_breakpoint_property("bottom_bg_padding_num",e)}}),m=new o.Number({model:this.model,use_breakpoint_property:!0,property:"bg_padding_num",label:"",default_value:this.model.get_breakpoint_property_value("bg_padding_num")||0,suffix:n.px,min:0,step:5,change:function(){var e=this.get_value();this.model.set_breakpoint_property("bg_padding_num",e),c.get_field().val(e),u.get_field().val(e),this.model.set_breakpoint_property("top_bg_padding_num",e,!0),this.model.set_breakpoint_property("bottom_bg_padding_num",e,!0)}}),f=new o.Select({model:this.model,use_breakpoint_property:!0,property:"region_role",label:n.roles_select_label,default_value:this.model.get_breakpoint_property_value("region_role"),values:[{label:n.roles.none,value:""},{label:n.roles.banner,value:"banner"},{label:n.roles.main,value:"main"},{label:n.roles.complementary,value:"complementary"},{label:n.roles.contentinfo,value:"contentinfo"}],change:function(){var e=this.get_value();this.model.set_breakpoint_property("region_role",e)}});e.append(d()),i=e.find(".upfront-region-bg-setting-padding-type"),s=e.find(".upfront-region-bg-setting-equal-padding"),l=e.find(".upfront-region-bg-setting-padding-top"),a=e.find(".upfront-region-bg-setting-padding-bottom"),"varied"===this.model.get_breakpoint_property_value("bg_padding_type")?s.hide():(l.hide(),a.hide()),p.render(),i.append(p.$el),c.render(),l.append(c.$el),u.render(),a.append(u.$el),m.render(),s.append(m.$el),f.render(),e.find(".upfront-region-bg-setting-aria-role").append(f.$el)},apply_region_scope:function(e,t,n,i){var o,r=this,s=e.get_sub_regions(),l=e.get("title"),a=e.get("name"),g=function(e){var o=r.get_region_css_styles(e);if(e.set({scope:t},{silent:!0}),n&&a!=n){var s=new RegExp("^"+l,"i"),g=new RegExp("^"+a,"i"),d=e.get("title").replace(s,i),p=e.get("name").replace(g,n);e.set({container:n,title:d,name:p},{silent:!0})}r.set_region_css_styles(e,o.styles,o.selector),e.get("properties").trigger("change")};e.is_main()&&_.each(s,function(e){_.isArray(e)?_.each(e,function(e){g(e)}):e&&g(e)}),o=r.get_region_css_styles(e),e.set({scope:t},{silent:!0}),n&&a!=n&&e.set({title:i,name:n,container:n},{silent:!0}),r.set_region_css_styles(e,o.styles,o.selector),e.get("properties").trigger("change")},get_region_css_styles:function(e){return Upfront.Application.cssEditor.init({model:e,type:e.is_main()?"RegionContainer":"Region",element_id:e.is_main()?"region-container-"+e.get("name"):"region-"+e.get("name"),no_render:!0}),{styles:t.trim(Upfront.Application.cssEditor.get_style_element().html()),selector:Upfront.Application.cssEditor.get_css_selector()}},set_region_css_styles:function(e,t,n){t&&(Upfront.Application.cssEditor.init({model:e,type:e.is_main()?"RegionContainer":"Region",element_id:e.is_main()?"region-container-"+e.get("name"):"region-"+e.get("name"),no_stylename_fallback:!0,no_render:!0}),selector=Upfront.Application.cssEditor.get_css_selector(),n!=selector&&(t=t.replace(new RegExp(n.replace(/^\./,"."),"g"),selector)),Upfront.Application.cssEditor.get_style_element().html(t),Upfront.Application.cssEditor.saveCall(!1))},render_expand_lock:function(e){var t=this.model.get_breakpoint_property_value("expand_lock",!0),i=this.model.get("type"),r=!1;r="full"==i;var s=new o.Toggle({model:this.model,property:"expand_lock",default_value:t,layout:"horizontal-inline",values:[{label:n.auto_resize,value:!0,disabled:r}],change:function(){if(!r){var e=this.model.get_breakpoint_property_value("expand_lock");this.model.set_breakpoint_property("expand_lock",!e)}}});e.html(""),s.render(),e.append(s.$el)},trigger_edit_css:function(){Upfront.Application.cssEditor.init({model:this.model,type:this.model.is_main()?"RegionContainer":"lightbox"==this.model.get("type")?"RegionLightbox":"Region",element_id:this.model.is_main()?"region-container-"+this.model.get("name"):"region-"+this.model.get("name")}),this.listenTo(Upfront.Application.cssEditor,"updateStyles",this.adjust_grid_padding)},trigger_trash:function(){if("undefined"!=typeof e&&e.preventDefault(),confirm(n.section_delete_nag)){var i=this.$el.closest(".upfront-region-container-bg").children(".upfront-region-bg-overlay");i.length>0&&i.data("uparallax")&&i.uparallax("destroy");var o=this.parent_view;"lightbox"==this.model.get("type")&&this.hide();var r=this.model.collection||this.collection;if(this.model.is_main()){var s=this.model.get_sub_regions();_.each(s,function(e,t){_.isArray(e)?_.each(e,function(e){r.remove(e)}):_.isObject(e)&&r.remove(e)})}this.close(),"fixed"===this.model.get("type")?(this.parent_view.get_container_view(this.model).close_edit(),r.remove(this.model)):r.remove(this.model);var l=r.total_container(["shadow","lightbox"]);0==l&&o.$el.find("#no_region_add_one").length<1&&o.$el.append(t("<a>").attr("id","no_region_add_one").text(n.no_region_add).one("click",function(){var e=!1,i="main",o=n.main_area;r.get_by_name(i)&&(e=r.get_new_title("Main ",2),o=e.title,i=e.name);var s=new Upfront.Models.Region(_.extend(_.clone(Upfront.data.region_default_args),{name:i,container:i,title:o})),l={};s.set_property("row",Upfront.Util.height_to_row(t(window).height())),s.add_to(r,0,l),t(this).remove()}))}Upfront.Events.trigger("entity:layout:change")},toggle_advanced_settings:function(){this.$el.find(".advanced-settings").hasClass("uf-settings-panel--expanded")?this.$el.find(".advanced-settings").removeClass("uf-settings-panel--expanded").find(".uf-settings-panel__body").hide():this.$el.find(".advanced-settings").addClass("uf-settings-panel--expanded").find(".uf-settings-panel__body").show(),this.set_settings_content_max_height()},on_click_cancel:function(){return this.reset_models(),this.close(!1)},adjust_grid_padding:function(){var e=new Upfront.Views.Editor.Command_ToggleGrid;e.update_grid()}})})}(jQuery);