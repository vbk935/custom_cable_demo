!function(e){upfrontrjs.define(["text!elements/upfront-image/tpl/video_editor.html"],function(t){var o,i=Upfront.Settings.l10n.image_element,n=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views,r=Backbone.View.extend({selectorTpl:_.template(e(t).find("#selector-tpl").html()),progressTpl:_.template(e(t).find("#progress-tpl").html()),formTpl:_.template(e(t).find("#upload-form-tpl").html()),defaultOptions:{multiple:!1,multiple_sizes:!0,preparingText:n.preparing_video_upload},options:{},initialize:function(){this.setup_upload_form()},setup_upload_form:function(){var t=this;if(0===e("#upfront-upload-video").length){e("body").append(t.formTpl({url:Upfront.Settings.ajax_url,l10n:i.template})),e("body").bind("keyup",function(e){27===e.keyCode&&t.closeOverlay()});var o=e("#upfront-progress"),r=e("#upfront-video-file-input"),a=e("#upfront-upload-video");a.fileupload&&a.fileupload({sequentialUploads:!0,formData:_.extend({action:"upfront-media-upload"},Upfront.Media.Ref),fileInput:null,paramName:"media[]"}).bind("fileuploadstart",function(){o.css("width","0")}).bind("fileuploadprogressall",function(e,t){var i=parseInt(t.loaded/t.total*100,10);o.css("width",i+"%")}).bind("fileuploaddone",function(i,r){var l=r.result;o.css("width","100%"),e("#upfront-image-uploading h2").html(n.preparing_video_upload),t.onFileUploadDone(l),a[0].reset()}).bind("fileuploadfail",function(e,o){var i;i="undefined"!==o.jqXHR.responseJSON&&o.jqXHR.responseJSON?o.jqXHR.responseJSON.error:o.jqXHR.statusText,Upfront.Views.Editor.notify(i,"error"),t.openSelector(),a[0].reset()}),r.on("change",function(){if(this.files.length){if(null===this.files[0].name.match(/\.(mp4|webm)$/))return void Upfront.Views.Editor.notify(n.allowed_video_type_error,"error");XMLHttpRequest&&(new XMLHttpRequest).upload?t.uploadVideo(this.files):t.openProgress(function(){a.fileupload("add",{fileInput:r})})}})}e("#upfront-upload-video").hide()},onFileUploadDone:function(t){var n=this;Upfront.Util.post({action:"upfront-media-video_info",video_id:t.data[0]}).done(function(i){var n=e("source",i.data.url).attr("src").split("?")[0];e("body").append('<video id="tempVideoForThumb" controls="controls" preload="none"></video>');var r=e("#tempVideoForThumb"),a=r[0],l=!1,s=function(){var e=n.split("/");e=e[e.length-1],e=e.split("."),e=e[0]+"-video-thumbnail.png",l=!0;var s=r.width(),p=r.height(),d=document.createElement("canvas"),u=Math.round(s/p*100)/100;d.width=s,d.height=p;var f=d.getContext("2d");f.drawImage(a,0,0,s,p);var c=d.toDataURL(),h={videoId:t.data[0],embed:i.data.url,width:s,height:p,aspect:u,base64image:c,thumbname:e,action:"upfront-save-video-info"};Upfront.Util.post(h).done(function(e){var n={id:t.data[0],embed:i.data.url,cover:e.data.thumburl,width:s,height:p,aspect:u};o.resolve(n),r.remove()})};a.addEventListener("canplay",function(){this.currentTime=0},!1),a.addEventListener("seeked",function(){l||s()},!1),a.src=n,a.load()}).error(function(){Upfront.Views.Editor.notify(i.sel.upload_error,"error"),n.openSelector()})},open:function(t){return o=e.Deferred(),_.isObject(t)||(t={}),this.options=_.extend({},this.defaultOptions,t),this.openSelector(),Upfront.Events.trigger("upfront:element:edit:start","media-upload"),o.promise()},openSelector:function(){var t=this;this.openOverlaySection(this.selectorTpl,{},function(){var o=e("#upfront-video-file-input");t.options.multiple===!0?(o.attr("multiple","multiple"),o.attr("name","media[]")):(o.attr("multiple",!1),o.removeAttr("multiple"),o.attr("name","media")),e("#upront-image-placeholder").on("dragenter",function(e){e.preventDefault(),e.stopPropagation()}).on("dragleave",function(t){t.preventDefault(),t.stopPropagation(),e(this).css("border-color","#C3DCF1"),e(this).css("background","none")}).on("dragover",function(t){t.preventDefault(),t.stopPropagation(),e(this).css("border-color","#1fcd8f"),e(this).css("background","rgba(255,255,255,.1)"),e(this).find()}).on("drop",function(e){var o;e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer&&(o=e.originalEvent.dataTransfer.files,o.length&&t.uploadVideo(o))}),t.resizeOverlay()})},openProgress:function(e){var t=this;this.openOverlaySection(this.progressTpl,{},function(){t.resizeOverlay(),e()})},resizeOverlay:function(){var t=e("#upfront-image-overlay");if(t.length){var o=e("#upront-image-placeholder"),i=e("#upfront-image-uploading"),n={},r=parseInt(e("#page").css("marginLeft"),10),a={left:r,width:e(window).width()-r,height:e(window).height()},l=a.height/2-220;l>0?(t.removeClass("small_placeholder"),l+="px"):(t.addClass("small_placeholder"),l=a.height/2-140+"px"),t.css(a),n={height:a.height-100,"padding-top":l},o.css(n),i.css(n)}},close:function(){this.closeOverlay()},cancelOverlay:function(e){e.target===e.currentTarget&&this.closeOverlay(e)},closeOverlay:function(){e("#upfront-image-overlay").off("click").fadeOut("fast",function(){e(this).remove(),e("#upfront-image-overlay").remove()}),e("html").css({overflow:this.bodyOverflow?this.bodyOverflow:"auto",height:"auto",width:"auto"}),e("body").removeClass("upfront-image-upload-open"),this.reopenSettings&&(e("#settings").fadeIn(),this.reopenSettings=!1),e(window).off("resize",this.resizeOverlay),Upfront.Events.trigger("upfront:element:edit:stop")},openOverlaySection:function(t,o,n){var r=this,a=e("#settings"),l=e("#upfront-image-overlay");return o.l10n=i.template,l.length?void e(".upfront-image-section").fadeOut("fast",function(){var i=e(t(o)).hide();l.append(i),i.fadeIn("fast"),e(this).remove(),n&&n(l)}):(this.bodyOverflow=e("html").css("overflow"),e("html").css({overflow:"hidden",width:e(window).width()+"px",height:e(window).height()+"px"}),l=e('<div id="upfront-image-overlay" class="upfront-ui"></div>').append(t(o)).hide(),e("body").append(l).addClass("upfront-image-upload-open"),this.setOverlayEvents(),l.fadeIn("fast"),this.resizeOverlay(),e(window).on("resize",function(e){e.target===window&&r.resizeOverlay()}),a.is(":visible")&&(a.fadeOut(),this.reopenSettings=!0),void(n&&n(l)))},setOverlayEvents:function(){var t=this;e("#upfront-image-overlay").on("click",function(e){t.cancelOverlay(e)}).on("click","a.select-files",function(e){t.openFileBrowser(e)}).on("click","a.open-media-gallery",function(e){t.openMediaGallery(e)})},openMediaGallery:function(t){var n=this,r={multiple_selection:this.options.multiple,multiple_sizes:this.options.multiple_sizes,media_type:["videos"]};t.preventDefault(),Upfront.Media.Manager.open(r).done(function(t,r){if(r&&r.length>0){var a=r.at(0).get("ID");Upfront.Util.post({action:"upfront-get-video-info",video_id:a}).done(function(e){o.resolve(e.data.videoinfo)}).error(function(){Upfront.Views.Editor.notify(i.sel.upload_error,"error"),n.openSelector()}),n.openProgress(function(){e("#upfront-image-uploading h2").html(n.options.preparingText)})}})},openFileBrowser:function(t){t.preventDefault(),e("#upfront-video-file-input").click()},checkFileUpdate:function(){return!0},uploadVideo:function(t){var o=this;o.setup_upload_form(),this.openProgress(function(){e("#upfront-upload-video").fileupload("send",{files:t})})}});return r})}(jQuery);