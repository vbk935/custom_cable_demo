!function(e){upfrontrjs.define(["scripts/upfront/link-model","text!scripts/upfront/templates/link-panel.html","scripts/upfront/inline-panels/inline-tooltip"],function(t,l,n){var i=function(){var e,t=Upfront.Application.layout.get("regions"),l=[{id:"#page",label:Upfront.Settings.l10n.global.views.back_to_top}];return e=function(t){t.each(function(t){var n=t.get_property_value_by_name("anchor");n&&n.length&&l.push({id:"#"+n,label:n}),t.get("objects")&&(t.get("objects")||{}).each?t.get("objects").each(function(e){var t=e.get_property_value_by_name("anchor");t&&t.length&&l.push({id:"#"+t,label:t})}):t.get("modules")&&e(t.get("modules"))})},t.each(function(t){if("shadow"!=t.get("name")){var n=t.attributes.title,i="#upfront-region-container-"+t.attributes.name;l.push({id:i,label:n}),e(t.get("modules"))}}),l},o=function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){"attachment"!=t.name&&e.push({name:t.name,label:t.label})}),e},a=function(){var e=[],t=(Upfront.Application.layout||{}).get?Upfront.Application.layout.get("regions"):[];return _.each(t.models,function(t){"lightbox"==t.attributes.sub&&e.push({id:"#"+t.get("name"),label:t.get("title")})}),e},s=Backbone.View.extend({tpl:_.template(l),defaultLinkTypes:{unlink:!0,external:!0,entry:!0,anchor:!0,image:!1,lightbox:!0,email:!0,phone:!0,homepage:!0},events:{"click .js-ulinkpanel-input-entry":"openPostSelector","keydown .js-ulinkpanel-lightbox-input":"onLightboxNameInputChange","click .upfront-apply":"saveControls","blur .js-ulinkpanel-input-external":"onUrlInputBlur","click .upfront-save_settings":"onOkClick","keydown .js-ulinkpanel-input-url.js-ulinkpanel-input-external":"onExternalUrlKeydown","click .link-panel-lightbox-trigger":"visit_lightbox"},className:"ulinkpanel-dark upfront-panels-shadow",visit_lightbox:function(t){t.preventDefault();var l=e(t.target).data("lightbox");if(l&&""!==l){var n=Upfront.Application.layout.get("regions");if(region=!!n&&n.get_by_name(this.getUrlanchor(l)),region){_.each(n.models,function(e){"lightbox"==e.attributes.sub&&Upfront.data.region_views[e.cid].hide()});var i=Upfront.data.region_views[region.cid];i.show()}}},getUrlanchor:function(t){if("undefined"==typeof t&&(t=e(location).attr("href")),t.indexOf("#")>=0){var l=t.split("#");return l[1]}return!1},initialize:function(e){if(e.linkTypes&&e.linkTypes.image&&e.linkTypes.image===!0&&_.isUndefined(e.imageUrl))throw'Provide "imageUrl" if "linkTypes" option has { image: true } when initializing LinkPanel.';if(this.options=e||{},this.linkTypes=_.extend({},this.defaultLinkTypes,e.linkTypes||{}),this.theme=e.theme||"dark",this.button=e.button||!1,this.title=e.title||Upfront.Settings.l10n.global.content.links_to,"undefined"==typeof e.model)return void Upfront.Util.log("There was no link model, use new linking.");var t=this.get_mapped_url();"anchor"===this.model.get("type")&&null!==this.model.get("url").match(/^#/)&&this.model.set({url:t+this.model.get("url")},{silent:!0}),this.listenTo(this.model,"change:type",this.handleTypeChange)},get_mapped_url:function(){var e=Upfront.mainData.site||document.location.origin,t=Upfront.mainData.siteUrl||document.location.origin,l=t.split("/")[3],n=document.location.pathname;if(e!==t&&l&&""!==l&&n.search(l)>-1){var i=n.split("/");i.shift(),i.shift(),n="/"+i.join("/")}return n.search("edit")>-1?"":e+n},onOkClick:function(){"lightbox"===this.model.get("type")&&""!==this.$el.find(".js-ulinkpanel-lightbox-input").val()?this.createLightBox():(this.close(),this.model.trigger("change"))},onExternalUrlKeydown:function(e){return 13!==e.which||(e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),this.onOkClick(e),this.trigger("url:changed"),Upfront.Events.trigger("tooltip:close"),!1)},close:function(){this.trigger("linkpanel:close")},handleTypeChange:function(){"homepage"===this.model.get("type")?this.model.set({url:Upfront.mainData.site},{silent:!0}):this.model.set({url:""},{silent:!0}),this.render(),"entry"===this.model.get("type")&&this.openPostSelector(),"image"===this.model.get("type")&&this.model.set({url:this.options.imageUrl})},getLinkTypeValue:function(e){var t=Upfront.Settings.l10n.global.content;switch(e){case"homepage":return{value:"homepage",label:t.homepage,icon:"link-homepage",tooltip:t.homepage};case"unlink":return{value:"unlink",label:t.no_link,icon:"link-unlink",tooltip:t.unlink};case"external":return{value:"external",label:t.url,icon:"link-external",tooltip:t.external};case"email":return{value:"email",label:t.email,icon:"link-email",tooltip:t.email};case"phone":return{value:"phone",label:t.phone,icon:"link-phone",tooltip:t.phone};case"entry":return{value:"entry",label:t.post_or_page,icon:"link-entry",tooltip:t.post_or_page};case"anchor":return{value:"anchor",label:t.anchor,icon:"link-anchor",tooltip:t.anchor};case"image":return{value:"image",label:t.larger_image,icon:"link-image",tooltip:t.larger_image};case"lightbox":return{value:"lightbox",label:t.lightbox,icon:"link-lightbox",tooltip:t.lightbox}}},openPostSelector:function(e){e&&e.preventDefault(),this.trigger("linkpanel:update:wrapper");var t=this,l={postTypes:o()};Upfront.Views.Editor.PostSelector.open(l).done(function(e){t.model.set({title:e.get("post_title"),url:e.get("permalink"),object:e.get("post_type"),object_id:e.get("ID")}),t.render()})},onLightboxNameInputChange:function(e){13===e.which&&(e.preventDefault(),this.handleLightboxCreate())},handleLightboxCreate:function(){this.createLightBox(),this.saveControls(),Upfront.Events.trigger("tooltip:close")},createLightBox:function(){var t=e.trim(this.$(".js-ulinkpanel-lightbox-input").val());return t?(this.model.set({url:"#"+Upfront.Application.LayoutEditor.getLightboxSafeName(t)}),Upfront.Application.LayoutEditor.createLightboxRegion(t),this.model.trigger("change",!0),void this.render()):(Upfront.Views.Editor.notify(Upfront.Settings.l10n.global.views.ltbox_empty_name_nag,"error"),!1)},onUrlInputBlur:function(t){var l=e(t.currentTarget).val().trim();this.model.get("type")&&"external"!==this.model.get("type")&&"unlink"!==this.model.get("type")||l.match(/https?:\/\//)||_.isEmpty(l)||(l="http://"+l),"email"!==this.model.get("type")||l.match(/^mailto:/)||(l="mailto:"+l),"phone"!==this.model.get("type")||l.match(/^tel:/)||(l="tel:"+l,this.model.set({target:"_self"})),this.model.set({url:l}),this.render()},render:function(){if(!this.model)return void this.$el.html("Error occurred, link panel switch to new style.");this.model.get("url")||this.model.get("type")||this.model.set({type:"external"},{silent:!0});var e=this.model,t=e.get("title"),l=e.get("url");"undefined"!=typeof t&&e.set("display_title",t.length>25?t.substr(0,25)+"...":t,{silent:!0}),"undefined"!=typeof l&&e.set("display_url",l.length>25?l.substr(0,25)+"...":l,{silent:!0});var n="lightbox"===this.model.get("type")&&this.model.get("url"),i={title:this.title,link:e.toJSON(),checked:'checked="checked"',lightboxes:a(),button:this.button,type:this.model.get("type"),lightbox:n};this.$el.html(this.tpl(i)),this.renderTypeSelect(),"anchor"==this.model.get("type")&&this.renderAnchorSelect(),"lightbox"==this.model.get("type")&&(a().length?(this.renderLightBoxesSelect(),this.$el.find(".js-ulinkpanel-new-lightbox").hide()):this.$el.find(".js-ulinkpanel-new-lightbox").show()),_.contains(["external","unlink"],this.model.get("type"))&&this.renderTargetRadio(),this.updateWrapperSize(),this.delegateEvents(),this.renderTooltips()},saveControls:function(e){var t=this.model.get("type");"lightbox"===t&&""!==this.$el.find(".js-ulinkpanel-lightbox-input").val()&&(e.preventDefault(),this.handleLightboxCreate()),this.$el.find(".lightbox-selector").show(),this.$el.find(".js-ulinkpanel-new-lightbox").hide()},newLightbox:function(){this.$el.find(".lightbox-selector").hide(),this.$el.find(".js-ulinkpanel-new-lightbox").show()},updateWrapperSize:function(){var t=0;this.$el.children().each(function(l,n){var i=0;i=e(n).hasClass("upfront-field-post-pages")?parseInt(e(n).find(".js-ulinkpanel-input-entry").outerWidth(),10):e(n).hasClass("upfront-settings-link-target")?0:parseInt(e(n).width(),10),t+=i}),this.$el.css("width",t+10),this.$el.closest(".ulinkpanel-dark").css("width",t+10),this.$el.closest(".redactor_air").css("width",t+10)},getTooltipSelect:function(t){var l=this,n=Upfront.Views.Editor.Field.Select.extend({className:"upfront-field-wrap upfront-field-wrap-select",render:function(){n.__super__.render.apply(this,arguments);var e=this;_.each(this.options.values,function(n){var i=e.$el.find('[value="'+n.value+'"]').parent();l.addTooltip(i,n.tooltip?n.tooltip:n.label,t)})},openOptions:function(t){if(t&&t.stopPropagation(),this.$el.find(".upfront-field-select").hasClass("upfront-field-select-expanded"))return void e(".upfront-field-select-expanded").removeClass("upfront-field-select-expanded");e(".upfront-field-select-expanded").removeClass("upfront-field-select-expanded"),this.$el.find(".upfront-field-select").css("min-width","").css("min-width",this.$el.find(".upfront-field-select").width()),this.$el.find(".upfront-field-select").addClass("upfront-field-select-expanded");var l=this;_.delay(function(){var t=l.$el.parents("#sidebar-ui").length,n=l.$el.parents("#element-settings-sidebar").length,i=46;if(1==t||1==n){var o=l.$el.find(".upfront-field-select-options"),a=o.parent(),s=a.offset().top-e("#element-settings-sidebar").offset().top;s+=i,o.css("width",a.width()+3),o.css("top",s+"px"),Upfront.Util.isRTL()?o.css("right",e(window).width()-a.offset().left-a.width()+"px"):o.css("left",a.offset().left+"px"),o.css("display","block")}},10),e(".sidebar-panel-content, #sidebar-scroll-wrapper").on("scroll",this,this.on_scroll),this.trigger("focus")}});return n},renderTypeSelect:function(){var e=this,t=[];_.each(this.linkTypes,function(l,n){l&&(e.model.get("url")||"unlink"!==n)&&t.push(this.getLinkTypeValue(n))},this);var l=this.getTooltipSelect("side"),n=this.model.get("type");"unlink"!==this.model.get("type")&&this.model.get("type")||(n="external"),this.typeSelect=new l({label:"",className:"upfront-link-select",values:t,default_value:n,change:function(){e.model.set({type:this.get_value()}),Upfront.Events.trigger("tooltip:close"),"unlink"===this.get_value()&&e.close()}}),this.typeSelect.render(),this.$el.find(".upfront-settings-link-select").prepend(this.typeSelect.el)},renderTooltips:function(){this.$el.find(".upfront-link-back, .js-ulinkpanel-input-external, .js-ulinkpanel-input-url, .ulinkpanel-entry-browse, .js-ulinkpanel-input-phone, .upfront-home-link, .js-ulinkpanel-input-url, .anchor-selector, .js-ulinkpanel-input-email, .upfront-create-new-lightbox").utooltip({fromTitle:!0});var e=this.model.get("type"),e="unlink"===e?"external":e,t=this.getLinkTypeValue(e);this.$el.find(".upfront-link-select .upfront-field-select").utooltip({fromTitle:!1,content:t.tooltip});var l,n=this.model.get("target");l="_blank"===n?Upfront.Settings.l10n.global.content.blank_label:Upfront.Settings.l10n.global.content.self_label,this.$el.find(".uf-link-target-select .upfront-field-select").utooltip({fromTitle:!1,content:l})},addTooltip:function(t,l,n){e(t).utooltip({fromTitle:!1,content:l,panel:n})},renderTargetRadio:function(){var e=this,t=this.getTooltipSelect("normal");this.targetRadio=new t({label:"",className:"uf-link-target-select",default_value:this.model.get("target")||"_self",values:[{label:Upfront.Settings.l10n.global.content.blank,value:"_blank",tooltip:Upfront.Settings.l10n.global.content.blank_label},{label:Upfront.Settings.l10n.global.content.self,value:"_self",tooltip:Upfront.Settings.l10n.global.content.self_label}],change:function(){e.model.set({target:this.get_value()}),e.renderTooltips()}}),this.targetRadio.render(),this.$el.find(".upfront-settings-link-target").append(this.targetRadio.el)},renderAnchorSelect:function(){var e=this.model,t=this.get_mapped_url(),l=[{label:"Choose Anchor...",value:""}];_.each(i(),function(e){l.push({label:e.label,value:t+e.id})});var n=this.model.get("url");n=n?n:"",n=n.indexOf("#")!==-1?n:"",this.anchorSelect=new Upfront.Views.Editor.Field.Select({label:"",values:l,default_value:n,change:function(){var t=this.get_value();null!==document.location.pathname.match(/^\/create_new\//)&&(t="#"+t.split("#")[1]),e.set({url:t})}}),this.anchorSelect.render(),this.$el.find(".anchor-selector").append(this.anchorSelect.el)},renderLightBoxesSelect:function(){var e=this.model,t=this,l=[{label:Upfront.Settings.l10n.global.content.choose_lightbox,value:!1}];_.each(a()||[],function(e){l.push({label:e.label,value:e.id})});var n=this.model.get("url");n=n?n:"",n=n.match(/^#/)?n:"",this.lightboxSelect=new Upfront.Views.Editor.Field.Select({label:"",className:"upfront-lightbox-select",values:l,default_value:n,change:function(l){e.set({url:l}),t.$el.find(".link-panel-lightbox-trigger").data("lightbox",l)}}),this.lightboxSelect.render(),this.$el.find(".lightbox-selector").append(this.lightboxSelect.el),this.$el.find(".upfront-lightbox-select ul").prepend('<li class="upfront-field-select-option upfront-create-new-lightbox" title="'+Upfront.Settings.l10n.global.content.create_lightbox+'"><label>'+Upfront.Settings.l10n.global.content.new_lightbox+"</label></li>"),l.length>4&&this.$el.find(".upfront-lightbox-select ul").addClass("upfront-field-select-options-scrollbar"),this.$el.find(".upfront-create-new-lightbox").on("click",function(e){t.newLightbox()})},delegateEvents:function(e){this.typeSelect&&this.typeSelect.delegateEvents(),this.anchorSelect&&this.anchorSelect.delegateEvents(),this.lightboxSelect&&this.lightboxSelect.delegateEvents(),Backbone.View.prototype.delegateEvents.call(this,e)}});return s})}(jQuery);